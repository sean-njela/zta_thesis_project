version: '3'

# â¬‡ï¸ 1. Load variables from a .env file
dotenv: ['.env']

# â¬‡ï¸ 2. Assign the loaded environment variables to Task variables
vars:
  IMAGE_NAME: '{{.IMAGE_NAME}}'
  IMAGE_TAG: '{{.IMAGE_TAG | default "$(git rev-parse --short HEAD)"}}'
  DOCKERFILE: '{{.DOCKERFILE}}'
  CONTEXT: '{{.CONTEXT}}'
  BUILDER_NAME: '{{.BUILDER_NAME}}'
  COMPOSE_FILE: '{{.COMPOSE_FILE}}'
  ENV: '{{.ENV}}'
tasks:

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Linting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint-helm:
    desc: "Lint Helm charts"
    cmds:
      - helm lint ./k8s/charts/zta-demo-app
      - helm lint ./k8s/charts/observability-stack

  # --------------------------
  # Helm Deployment Tasks
  # --------------------------
  create-cluster:
    desc: "Create a Kind cluster if it doesn't already exist"
    cmds:
      - kind create cluster -n thesis-demo --image kindest/node:v1.33.1 || echo "Cluster already exists"
    status:
      - kind get clusters | grep kind-thesis-demo

  create-namespace:
    desc: "Create a namespace for the Helm deployment"
    cmds:
      - kubectl create namespace zta-demo || echo "Namespace already exists"

  setup:
    desc: Create and bootstrap Buildx builder
    cmds:
      - docker buildx create --name {{.BUILDER_NAME}} --use || true
      - docker buildx inspect {{.BUILDER_NAME}} --bootstrap

  build-local:
    desc: Build local Docker image (no push)
    deps: [setup]
    cmds:
      - docker buildx build --platform linux/amd64 --file {{.DOCKERFILE}} --tag {{.IMAGE_NAME}}:{{.ENV}} . --load

  build-push:
    desc: Build multi-platform Docker image (push to registry)
    deps: [setup]
    cmds:
      - docker buildx build --platform {{.PLATFORMS}} --file {{.DOCKERFILE}} --tag {{.IMAGE_NAME}}:{{.IMAGE_TAG}} --tag {{.IMAGE_NAME}}:{{.ENV}} . --push


  _deploy:
    internal: true
    cmds:
      - |
        echo "Deploying Helm chart for {{.RELEASE_NAME}}..."
        kubens zta-demo
        helm upgrade --install {{.RELEASE_NAME}} \
          ./k8s/charts/zta-demo-app \
          -f ./k8s/dev/values-local.yaml \
          --set image.tag={{.ENV}}
        
        echo "Waiting for pods of {{.RELEASE_NAME}} to be ready..."
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance={{.RELEASE_NAME}} --timeout=60s || true

  deploy-all-local:
    desc: "Deploy both app1 and app2 to local cluster"
    deps: [create-cluster]
    vars:
      ENV: '{{.ENV | default "dev"}}'
    cmds:
      - echo "Building local Docker image with tag {{.ENV}}..."
      - task: build-local
        vars:
          ENV: '{{.ENV}}'
      - kubectx kind-thesis-demo
      - echo "Importing image to kind cluster..."
      - kind load docker-image {{.IMAGE_NAME}}:{{.ENV}} -n thesis-demo

      - task: _deploy
        vars:
          RELEASE_NAME: app1
          ENV: '{{.ENV}}'
      - task: _deploy
        vars:
          RELEASE_NAME: app2
          ENV: '{{.ENV}}'
      - |
        kubens zta-demo
        echo "Deployment status for all apps:"
        kubectl get all

  upgrade-all:
    desc: "Upgrades both helm charts when changes are made"
    cmds:
      - task: _deploy
        vars:
          RELEASE_NAME: app1
          ENV: '{{.ENV}}'
      - task: _deploy
        vars:
          RELEASE_NAME: app2
          ENV: '{{.ENV}}'
      - |
        kubens zta-demo
        echo "Upgrade status for all apps:"
        kubectl get all

  port-forward-app1:
    desc: "Forward local port 8081 to access app1"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      - |
        echo "Forwarding port 8081 -> 80 for app1 service"
        echo "Access app1 at http://localhost:8081"
        echo "Press Ctrl+C to stop port forwarding"
        kubectl port-forward svc/app1 8081:80

  port-forward-app2:
    desc: "Forward local port 8082 to access app2"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      - |
        echo "Forwarding port 8082 -> 80 for app2 service"
        echo "Access app2 at http://localhost:8082"
        echo "Press Ctrl+C to stop port forwarding"
        kubectl port-forward svc/app2 8082:80

  expose-kubeconfig:
    desc: "Expose cluster kubeconfig"
    cmds:
      - cat ~/.kube/config > config-k8s-dev.txt 
      - echo "Copy config-k8s-dev.txt into lens to view your cluster"

  uninstall-apps1&2:
    desc: "Uninstall both app1 and app2 from local cluster"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      - helm uninstall app1 || true
      - helm uninstall app2 || true

  # --------------------------
  # Observability Stack Tasks
  # --------------------------
  observability-deploy:
    desc: "Deploy observability stack (Grafana, Loki, Prometheus, Tempo, OpenTelemetry)"
    deps: [create-cluster]
    cmds:
      - |
        kubectx kind-thesis-demo
        echo "Creating observability namespace..."
        kubectl create namespace observability || echo "Namespace already exists"
        
        kubens observability
        echo "Adding Helm repositories..."
        helm repo add grafana https://grafana.github.io/helm-charts
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
        helm repo update
        
        echo "Updating chart dependencies..."
        helm dependency update ./k8s/charts/observability-stack
        
        echo "Deploying observability stack..."
        helm upgrade --install observability-stack ./k8s/charts/observability-stack \
          --wait \
          --timeout 10m
        
        echo "Observability stack deployment status:"
        kubectl get pods

  observability-status:
    desc: "Check observability stack status"
    cmds:
      - kubectx kind-thesis-demo
      - kubens observability
      - |
        echo "=== Observability Stack Status ==="
        kubectl get all
        echo ""
        echo "=== Pod Status ==="
        kubectl get pods -o wide

  port-forward-grafana:
    desc: "Forward port 3000 to access Grafana dashboard"
    cmds:
      - kubectx kind-thesis-demo
      - kubens observability
      - |
        echo "Forwarding port 3000 -> 80 for Grafana service"
        echo "Access Grafana at http://localhost:3000"
        echo "Username: admin | Password: admin123"
        echo "Press Ctrl+C to stop port forwarding"
        kubectl port-forward svc/observability-stack-grafana 3000:80

  observability-logs:
    desc: "View logs from observability stack components"
    cmds:
      - kubectx kind-thesis-demo
      - kubens observability
      - |
        echo "=== Grafana Logs ==="
        kubectl logs -l app.kubernetes.io/name=grafana --tail=20
        echo ""
        echo "=== Loki Logs ==="  
        kubectl logs -l app.kubernetes.io/name=loki --tail=20
        echo ""
        echo "=== OpenTelemetry Collector Logs ==="
        kubectl logs -l app.kubernetes.io/name=opentelemetry-collector --tail=20

  observability-uninstall:
    desc: "Uninstall observability stack"
    cmds:
      - kubectx kind-thesis-demo
      - kubens observability
      - helm uninstall observability-stack || echo "No release to uninstall"
      - kubectl delete namespace observability || echo "No namespace to delete"

  # --------------------------
  # Combined Deployment Tasks
  # --------------------------
  dev:
    desc: "Deploy both applications and observability stack"
    deps: [create-cluster, create-namespace]
    cmds:
      - task: observability-deploy
      - task: deploy-all-local
      - |
        echo ""
        echo "ðŸŽ‰ Full deployment complete!"
        echo "=== Access Information ==="
        echo "â€¢ App1: kubectl port-forward svc/app1 8081:80 -n zta-demo"
        echo "â€¢ App2: kubectl port-forward svc/app2 8082:80 -n zta-demo"
        echo "â€¢ Grafana: kubectl port-forward svc/observability-stack-grafana 3000:80 -n observability"
        echo ""
        echo "=== Quick Status Check ==="
        kubectx kind-thesis-demo
        kubens zta-demo
        kubectl get pods 
        kubens observability
        kubectl get pods

  cleanup-cluster:
    desc: "Cleanup kind cluster"
    cmds:
      - kubectx kind-thesis-demo
      - kind delete cluster -n thesis-demo || echo "No cluster to delete"

  cleanup-helm:
    desc: "Cleanup helm releases"
    cmds:
      - kubectx kind-thesis-demo
      - helm uninstall app1 || echo "No app1 release to uninstall"
      - helm uninstall app2 || echo "No app2 release to uninstall"
      - helm uninstall observability-stack || echo "No observability release to uninstall"

  cleanup-all:
    desc: "Cleanup all resources"
    cmds:
      - task: cleanup-cluster
      - task: cleanup-helm


  # --------------------------
  # Istio Tasks
  # -------------------------
  istio-install:
    desc: "Deploy Istio to the cluster"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      - kubectl label namespace zta-demo istio-injection=enabled
      #- kubectl apply -f https://raw.githubusercontent.com/istio/istio/1.17.11/manifests/istio-demo.yaml

  istio-uninstall:
    desc: "Uninstall Istio from the cluster"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      #- kubectl delete -f https://raw.githubusercontent.com/istio/istio/1.17.11/manifests/istio-demo.yaml
      #- kubectl label namespace zta-demo istio-injection=disabled


  # --------------------------
  # Kiali Tasks
  # -------------------------
  kiali-install:
    desc: "Deploy Kiali to the cluster"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      - |
        helm repo add kiali https://kiali.org/helm-charts
        helm install \
          --set cr.create=true \
          --set cr.namespace=zta-demo \
          --namespace kiali-operator \
          --create-namespace \
          kiali-operator \
          kiali/kiali-operator

  port-forward-kiali:
    desc: "Port forward Kiali to the cluster"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      - kubectl port-forward svc/kiali 20001:20001

  generate-kiali-token:
    desc: "Generate Kiali token"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      - kubectl create token kiali-service-account

  kiali-uninstall:
    desc: "Uninstall Kiali from the cluster"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      - helm uninstall kiali-operator


  # --------------------------
  # K8s Dashboard Tasks
  # -------------------------
  k8s-dashboard-install:
    desc: "Deploy K8s Dashboard to the cluster"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      #- kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.12.0/aio/deploy/recommended.yaml

  k8s-dashboard-uninstall:
    desc: "Uninstall K8s Dashboard from the cluster"
    cmds:
      - kubectx kind-thesis-demo
      - kubens zta-demo
      #- kubectl delete -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.12.0/aio/deploy/recommended.yaml